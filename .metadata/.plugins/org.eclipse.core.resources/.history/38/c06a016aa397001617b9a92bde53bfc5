package template;

import logist.topology.Topology.City;

import java.util.ArrayList;
import java.util.List;

import logist.plan.Action;
import logist.task.Task;

/**
 * State Class for the Deliberative Agent
 * @author Ignacio Aguado, Darío Martínez
 */
public class DeliberativeState {
	
	public City currentCity;
	public int capacity;
	public int costPerKm;
	public double benefits;
	public double totalBenefits;
	public List<Task> toPickupList;
	public List<Task> toDeliverList;
	public List<DeliberativeAction> actionHistory = new ArrayList<DeliberativeAction>();

	/**
	 * Initializer for a state
	 * 
	 * @param origin City where the agent is located without a task
	 */
	public DeliberativeState(City currentCity, int capacity, int costPerKm, double benefits, double totalBenefits, List<Task> toPickupList, List<Task> toDeliverList, List<DeliberativeAction> actionHistory) {
		this.currentCity = currentCity;
		this.capacity = capacity;
		this.costPerKm = costPerKm;
		this.benefits = benefits;
		this.toPickupList = toPickupList;
		this.toDeliverList = toDeliverList;
		this.actionHistory = actionHistory;
		this.totalBenefits = totalBenefits;
		
	}
	
	public DeliberativeState move(City nextCity) {
		double newBenefits = -currentCity.distanceTo(nextCity)*costPerKm;
		double newTotalBenefits = this.totalBenefits + newBenefits;
		DeliberativeAction action = new DeliberativeAction(nextCity);
		List<DeliberativeAction> newActionHistory = actionHistory;
		newActionHistory.add(action);
		DeliberativeState newState = new DeliberativeState(nextCity, capacity, costPerKm, newBenefits, newTotalBenefits, toPickupList, toDeliverList, newActionHistory);
		System.out.println("MOVE to " + nextCity);
		return newState;
	}
	
	public DeliberativeState pickup(Task pickedup) {
		
		int newCapacity = capacity - pickedup.weight;
		double newBenefits = 0;
		List<Task> newToPickupList = toPickupList;
		newToPickupList.remove(pickedup);
		List<Task> newToDeliverList = toDeliverList;
		newToDeliverList.add(pickedup);
		DeliberativeAction action = new DeliberativeAction("PICKUP", pickedup);
		List<DeliberativeAction> newActionHistory = actionHistory;
		newActionHistory.add(action);
		DeliberativeState newState = new DeliberativeState(currentCity, newCapacity, costPerKm, newBenefits, totalBenefits, newToPickupList, newToDeliverList, newActionHistory);
		System.out.println("PICK UP in " + currentCity);

		return newState;
	}
	
	public DeliberativeState deliver(Task delivered) {
		int newCapacity = capacity + delivered.weight;
		double newBenefits = delivered.reward;
		double newTotalBenefits = this.totalBenefits + newBenefits;
		List<Task> newToDeliverList = toDeliverList;
		newToDeliverList.remove(delivered);
		DeliberativeAction action = new DeliberativeAction("DELIVERY", delivered);
		List<DeliberativeAction> newActionHistory = actionHistory;
		newActionHistory.add(action);
		DeliberativeState newState = new DeliberativeState(currentCity, newCapacity, costPerKm, newBenefits, newTotalBenefits, toPickupList, newToDeliverList, newActionHistory);
		System.out.println("DELIVER in " + currentCity);

		return newState;
	}
	
	public boolean canPickup(Task toPickup) {
		return capacity-toPickup.weight >= 0;
	}
	
	public List<DeliberativeState> getNextStates() {
		List<DeliberativeState> nextStates = new ArrayList<DeliberativeState>();
		
		List<Task> toPickupListCopy = new ArrayList<Task>(toPickupList);

		for (Task deliverTask : toDeliverList) {
			if (deliverTask.deliveryCity.equals(currentCity)) {
				DeliberativeState newState = deliver(deliverTask);
				nextStates.add(newState);
				return nextStates;
			}
		}
		List<Task> toPickupListCopy = new ArrayList<Task>(toPickupList);
		for (Task pickupTask : toPickupListCopy) {
			if (pickupTask.pickupCity.equals(currentCity)) {
				DeliberativeState newState = pickup(pickupTask);
				nextStates.add(newState);
			}
		}
		
		for (City neighborCity : currentCity.neighbors()){
			DeliberativeState newState = move(neighborCity);
			nextStates.add(newState);
		}

		return nextStates;
	}
	
	public boolean isGoal() {
		boolean isGoal = toPickupList.isEmpty() && toDeliverList.isEmpty();
		return isGoal;
	}
	
	public int getLevelOfDepth() {
		return actionHistory.size();
	}
}
